# 中断

## 7.1 中断的概念
    暂停现在干的自己的事情，去干别的但是对于整个系统有利的事情  
    
    如果只有一个cpu的话，任何程序都必须串行执行，效率低下
    
    中断为了在多任务系统中，让多个程序并发执行。
    
    运用中断能够显著提升并发，从而大幅提升效率。

## 7.2 操作系统是中断驱动的

    首先操作系统其实就是一个死循环，如果没有jmp $ 这种提留的话，程序就会一直执行下去它也许会把最后一条指令后面的数据解码成某种指令，也许会因为不识别该指令解码失败而抛出 UD 异常，即未定义操作码、无效操作码（Undefined，Invalid Opcode）。

## 中断的分类

1. 外部中断（硬件中断）
- 中断源：某个硬件
    - 比如说网卡收到了来自网络的数据包，这时候网卡就会主动通知 CPU，CPU 得到通知后便将数据拷贝到内核缓冲区。
   
- CPU准备两条信号线 
    - CPU 提供统一的接口作为中断信号的公共线路，所有来自外设的中断信号都共享公共线路连接到 CPU）
    - 分别是：INTR（INTeRrupt） 和NMII（Non Maskable Interrupt），INTR 是可屏蔽中断，NMII 是不可屏蔽中断
         - INTR ：是外部设备，可屏蔽，随时处理，甚至可以不处理.
            - (可以通过 eflags 寄存器的 IF 标志位来屏蔽或打开中断，屏蔽后，CPU 不会响应中断信号)
            - 上下半分开处理： （上半处理）把中断处理程序中需要立即执行的部分（分分钟不能耽误的部分）划分到上半部，这部分是要限时执行的，所以通常情况下只完成中断应答或硬件复位等重要紧迫的工作。
            - 下半处理：（不紧急，推迟到下半）
            - 上下半处理，比如说网卡发来一个数据包，拿数据很急，所以就放到上半接收，放到内核缓存区，然而处理下半，比如说把数据包放到用户空间，这个就不急，就放到下半处理。
     
         - NMI ：是系统故障，比如电源故障，内存故障，系统崩溃等
            - 只是通知CPU一声而已。错误无法避免了
            -   CPU通过中断向量表或者中断描述符表（中断向量表是实模式下的中断处理程序数组，在保护模式下已经被中断描述符表代替）
            - 为导致宕机的原因分配一个中断向量号就好了
     ![外部中断](../poto/7/7-1.png)

2. 内部中断（软件中断）

- 内部中断可分为软中断和异常。
    - 软中断：由指令引起，如 int 0x80。（因为它来自于软件）
        - 可以发起的指令：“int 8位立即数” 
        - “int3” int3是调试断点指令，触发的中断向量号是3
    - 异常
        - into：除0异常(中断溢出指令)中断向量号是4,
        - bound：数组越界异常，中断向量号是5
        - ud2:未定义指令，中断向量号是6，表示指令无效
        - 还有很多种啦
        - 分类： Fault(故障)，Trap(陷阱)，Abort(异常终止)
            - Fault: 比如说除0异常，缺页异常 page fault，CPU会先尝试修复，如果修复不了，就会抛出异常，进入内核态
            - Trap: 比如说 int 0x80，CPU会直接进入内核态
            - Abort: 最严重的异常，比如说 ud2，CPU会直接进入内核态
        
- 异常和NEI都无视标志寄存器eflags的IF标志位，软中断也无视IF标志位，所以异常和软中断都是不可屏蔽的（所以只有INTR会受IF位是吧！！哈哈哈哈）


## 7.4 中断描述符表（IDT）

- 中断描述符表（IDT）是`保护模式`下用于存储`中断程序入口`的表。
- 中断向量表（Interrupt Vector Table，IVT）是在`实模式`下存储`中断处理程序入口`的表

- 中断描述符表有中断描述符（乐）。还有任务门描述符，陷阱门描述符。

- IDT和IVY区别：
    - 中断描述符表不限制，那里都可以。
    - 中断描述符表中的每一个描述符用8字节描述。IVY每个中断向量用 4 字节描述

1. 中断处理过程及保护
- 发生中断处理过程分为CPU 内， CPU外。
    - CPU内：外部设备的中断由中断代理芯片接收，处理后将该中断的中断向量号发送到 CPU
    - CPU外：CPU 执行该中断向量号对应的中断处理程序。
- 中断处理过程：

    1. 处理器根据中断向量号定位中断门描述符。
        - 中断向量号是中断描述符的索引
    ![中断处理过程](../poto/7/7-7.png)